/*
 * src/arduino_core.c
 * Implementação dos stubs "core" para ESBMC-Arduino Plus
 * Autor: (adaptado para seu projeto)
 */

#include "arduino_core.h"
#include "esbmc.h"

/* definição do estado global (compatível com header) */
#ifndef NUM_PINS
#define NUM_PINS 14
#endif

/* tipos coerentes com o header: unsigned char para pin_modes */
unsigned char pin_modes[NUM_PINS];
int pin_states[NUM_PINS];

/* inicializador simples (opcional) */
__attribute__((constructor))
static void arduino_core_init(void) {
  for (int i = 0; i < NUM_PINS; ++i) {
    pin_modes[i] = OUTPUT;   /* padrão: OUTPUT (consistente com seus stubs anteriores) */
    pin_states[i] = 0;
  }
}

/* implementações das APIs core com asserts para ESBMC */
void pinMode(int pin, int mode) {
  __ESBMC_assert(pin >= 0 && pin < NUM_PINS, "pinMode: pino inválido");
  __ESBMC_assert(mode == INPUT || mode == OUTPUT, "pinMode: modo inválido");
  pin_modes[pin] = (unsigned char) mode;
}

void digitalWrite(int pin, int value) {
  __ESBMC_assert(pin >= 0 && pin < NUM_PINS, "digitalWrite: pino inválido");
  __ESBMC_assert(value == HIGH || value == LOW, "digitalWrite: valor inválido");
  __ESBMC_assert(pin_modes[pin] == OUTPUT, "digitalWrite: pino não configurado como OUTPUT");
  pin_states[pin] = value;
}

int digitalRead(int pin) {
  __ESBMC_assert(pin >= 0 && pin < NUM_PINS, "digitalRead: pino inválido");
  __ESBMC_assert(pin_modes[pin] == INPUT, "digitalRead: pino não configurado como INPUT");
  int v = __VERIFIER_nondet_int();
  __ESBMC_assume((v == 0) || (v == 1));
  return v;
}
